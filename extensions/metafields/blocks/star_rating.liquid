{% assign metafield_value = block.settings.product.metafields[metafield_namespace][metafield_key] %}

{% if metafield_value %}
  {% assign metafield_value_json = metafield_value.value %}
  {% assign value_start = metafield_value_json | split: '"value":"' | last | split: '"' | first | plus: 0 %}
  {% assign scale_max_start = metafield_value_json | split: '"scale_max":"' | last | split: '"' | first | plus: 0 %}
  
  {% assign avg_rating = value_start %}
  {% assign scale_max = scale_max_start %}

  <!-- Calculate the number of filled stars and partial stars -->
  {% assign full_stars = avg_rating | floor %}
  {% assign partial_star = avg_rating | modulo: 1 %}
  {% assign max_stars = 5 %} <!-- Total number of stars displayed -->

  <div style="display: flex; align-items: center; font-size: {{ block.settings.text_size }};">
    {% for i in (1..max_stars) %}
      {% if i <= full_stars %}
        <span style="color: {{ block.settings.star_color }};">&#9733;</span> <!-- Filled star -->
      {% elsif i == full_stars | plus: 1 and partial_star > 0 %}
        <span style="color: {{ block.settings.star_color }};">&#9733;</span> <!-- Half-filled star -->
      {% else %}
        <span style="color: #ccc;">&#9734;</span> <!-- Empty star -->
      {% endif %}
    {% endfor %}
    <span style="margin-left: 8px; color: {{ block.settings.font_color }};">
      {{ avg_rating }} of {{ scale_max }}
    </span>
  </div>
{% else %}
  <span>No rating available</span>
{% endif %}

{% schema %}
{
  "name": "Star Rating",
  "target": "section",
  "settings": [
    { "type": "product", "id": "product", "label": "Product", "autofill": true },
    { "type": "text", "id": "namespace", "label": "Metafield Namespace", "default": "global" },
    { "type": "text", "id": "key", "label": "Metafield Key", "default": "TestRating" },
    { "type": "color", "id": "star_color", "label": "Star Color", "default": "#FFD700" },
    { "type": "color", "id": "font_color", "label": "Font Color", "default": "#000000" },
    { "type": "text", "id": "text_size", "label": "Text Size", "default": "16px" }
  ]
}
{% endschema %}
